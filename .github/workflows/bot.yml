name: elfak bot

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Setup Python environment
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # Step 3: Install system dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3 wget
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable chromium-chromedriver

      # Step 4: Install Python packages
      - name: Install Python packages
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 5: Run main scraper
      - name: Run main script
        env:
          MAIL: ${{ secrets.MAIL }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: python main.py

      # Step 6: Detect which courses changed
      - name: Detect course changes
        id: detect
        run: |
          for course in bp sp pj oopj lp oop aor1 dmat aip uur sip; do
            if git diff --name-only HEAD~1 HEAD | grep -q "^${course}.md$"; then
              echo "${course}_changed=true" >> $GITHUB_OUTPUT
            else
              echo "${course}_changed=false" >> $GITHUB_OUTPUT
            fi
          done

      # Step 7: Commit changes if any
      - name: Commit changes
        if: steps.detect.outputs.changed == 'true'
        uses: lazarevicOgnjen/git-auto-commit-action@v6
        with:
          commit_message: "Update course content"
          file_pattern: "*.md"

      # Step 8: Send notifications dynamically
      - name: Send course notifications
        env:
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        run: |
          import os
          import subprocess

          courses = {
              "bp": {"subject": "ğŸ“ Baze podataka", "forum": "https://cs.elfak.ni.ac.rs/nastava/mod/forum/search.php?id=4", "attachment": "bp.png"},
              "dmat": {"subject": "ğŸ“ Diskretna matematika", "forum": "https://cs.elfak.ni.ac.rs/nastava/mod/forum/search.php?id=97", "attachment": "dmat.png"},
              "sp": {"subject": "ğŸ“ Strukture podataka", "forum": "https://cs.elfak.ni.ac.rs/nastava/mod/forum/search.php?id=9", "attachment": "sp.png"},
              "pj": {"subject": "ğŸ“ Programski jezici", "forum": "https://cs.elfak.ni.ac.rs/nastava/mod/forum/search.php?id=11", "attachment": "pj.png"},
              "oopj": {"subject": "ğŸ“ Objektno orijentisano projektovanje", "forum": "https://cs.elfak.ni.ac.rs/nastava/mod/forum/search.php?id=62", "attachment": "oopj.png"},
              "lp": {"subject": "ğŸ“ LogiÄko projektovanje", "forum": "https://cs.elfak.ni.ac.rs/nastava/mod/forum/search.php?id=41", "attachment": "lp.png"},
              "oop": {"subject": "ğŸ“ Objektno orijentisano programiranje", "forum": "https://cs.elfak.ni.ac.rs/nastava/mod/forum/search.php?id=45", "attachment": "oop.png"},
              "aor1": {"subject": "ğŸ“ Arhitektura i organizacija raÄunara 1", "forum": "https://cs.elfak.ni.ac.rs/nastava/mod/forum/search.php?id=139", "attachment": "aor1.png"},
              "aip": {"subject": "ğŸ“ Algoritmi i programiranje", "forum": "https://cs.elfak.ni.ac.rs/nastava/mod/forum/search.php?id=3", "attachment": "aip.png"},
              "uur": {"subject": "ğŸ“ Algoritmi i programiranje", "forum": "https://cs.elfak.ni.ac.rs/nastava/mod/forum/search.php?id=2", "attachment": "uur.png"},
              "sip": {"subject": "ğŸ“ SIP", "forum": "https://sip.elfak.ni.ac.rs/", "attachment": "sip.png"}
          }

          for course, info in courses.items():
              changed = os.environ.get(f"{course}_changed", "false")
              email_file = f"{course}_emails.md"

              if changed == "true" and os.path.exists(email_file):
                  with open(email_file) as f:
                      to_emails = [line.strip() for line in f if line.strip()]
                  
                  if not to_emails:
                      print(f"No emails for {course}, skipping.")
                      continue

                  print(f"Sending {course} email to: {to_emails}")

                  # Call dawidd6/action-send-mail via subprocess
                  subprocess.run([
                      "gh", "run", "send-mail",  # placeholder for your actual email send logic
                      "--server_address", "smtp.gmail.com",
                      "--server_port", "587",
                      "--username", os.environ["EMAIL_USERNAME"],
                      "--password", os.environ["EMAIL_PASSWORD"],
                      "--to", ",".join(to_emails),
                      "--subject", info["subject"],
                      "--html_body", f"<p>Check forum: <a href='{info['forum']}'>{info['subject']} Forum</a></p>",
                      "--attachments", info["attachment"]
                  ])
